from typing import Optional, Dict, Any, List
import json
import random

class MarketingService:

    def __init__(self, db):
        self.db = db

    async def generate_marketing_idea(
        self,
        user_id: int,
        niche: str,
        goal: str,
        platform: str,
        custom_request: Optional[str] = None
    ) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–π –∏–¥–µ–∏ (–∑–∞–≥–ª—É—à–∫–∞)"""

        # –ó–∞–≥–ª—É—à–∫–∞ –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ LLM
        ideas_pool = [
            {
                "title": "–í–∏—Ä—É—Å–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂ –≤ —Å—Ç–æ—Ä–∏—Å",
                "problem": "–ù–∏–∑–∫–∞—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏",
                "solution": "–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º",
                "action_plan": [
                    "–°–æ–∑–¥–∞—Ç—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π —à–∞–±–ª–æ–Ω",
                    "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∫–ª–∞–º—É –Ω–∞ —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é",
                    "–ú–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —É—á–∞—Å—Ç–∏–µ–º –ø—Ä–∏–∑–∞–º–∏",
                    "–†–µ–ø–æ—Å—Ç–∏—Ç—å –ª—É—á—à–∏–µ —Ä–∞–±–æ—Ç—ã"
                ],
                "content_ideas": [
                    "–û–±–∑–æ—Ä–Ω—ã–π –ø–æ—Å—Ç –æ —á–µ–ª–ª–µ–Ω–¥–∂–µ",
                    "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—á–∞—Å—Ç–∏—é",
                    "–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã",
                    "–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à"
                ],
                "metrics": "–û—Ö–≤–∞—Ç 50K, –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å 15%",
                "budget_tips": "–ë—é–¥–∂–µ—Ç 5-10K —Ä—É–±–ª–µ–π –Ω–∞ –ø—Ä–∏–∑—ã"
            },
            {
                "title": "–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –±–ª–æ–≥ –≤ Telegram",
                "problem": "–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞",
                "solution": "–†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ–ª–µ–∑–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞",
                "action_plan": [
                    "–°–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü",
                    "–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª/—á–∞—Ç",
                    "–ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å 3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é",
                    "–ü—Ä–æ–≤–æ–¥–∏—Ç—å Q&A —Å–µ—Å—Å–∏–∏"
                ],
                "content_ideas": [
                    "–ö–µ–π—Å—ã –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏",
                    "–û–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã",
                    "–ò–Ω—Ç–µ—Ä–≤—å—é —Å —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏",
                    "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä—ã–Ω–∫–∞"
                ],
                "metrics": "–†–æ—Å—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ 1000/–º–µ—Å",
                "budget_tips": "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç, –≤—Ä–µ–º—è - –≥–ª–∞–≤–Ω—ã–π —Ä–µ—Å—É—Ä—Å"
            }
        ]

        response = random.choice(ideas_pool)
        response["title"] = f"{response['title']} –¥–ª—è {niche}"

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É —á–µ—Ä–µ–∑ UoW
        async with self.db.get_uow() as uow:
            idea = await uow.marketing_ideas.create(
                user_id=user_id,
                niche=niche,
                goal=goal,
                platform=platform,
                custom_request=custom_request,
                idea_title=response["title"],
                idea_description=json.dumps(response, ensure_ascii=False, indent=2),
                idea_examples=str(response["content_ideas"])
            )

        return response

    async def generate_social_post(
        self,
        user_id: int,
        topic: str,
        style: str = "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π"
    ) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π (–∑–∞–≥–ª—É—à–∫–∞)"""

        posts_pool = [
            {
                "headline": f"üöÄ –ü—Ä–æ—Ä—ã–≤ –≤ {topic}!",
                "hook": "–ó–Ω–∞–µ—Ç–µ –ª–∏ –≤—ã, —á—Ç–æ 90% –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π –¥–µ–ª–∞—é—Ç —ç—Ç—É –æ—à–∏–±–∫—É?",
                "body": f"–ú—ã –Ω–∞—à–ª–∏ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è {topic}, –∫–æ—Ç–æ—Ä–æ–µ –∏–∑–º–µ–Ω–∏—Ç –≤–∞—à –ø–æ–¥—Ö–æ–¥ –∫ –±–∏–∑–Ω–µ—Å—É. "
                        f"–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –Ω–∞—à–∏ –∫–ª–∏–µ–Ω—Ç—ã —É–≤–µ–ª–∏—á–∏–ª–∏ –ø—Ä–∏–±—ã–ª—å –Ω–∞ 47% –∑–∞ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü.",
                "cta": "üìû –ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é!",
                "hashtags": [f"#{topic}", "#–±–∏–∑–Ω–µ—Å", "#—É—Å–ø–µ—Ö", "#—Å–æ–≤–µ—Ç—ã"],
                "visual_tips": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫—É —Å —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"
            },
            {
                "headline": f"üéØ –°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—Ö–∞ –≤ {topic}",
                "hook": "–ü–æ—á–µ–º—É –æ–¥–Ω–∏ –ø—Ä–µ—É—Å–ø–µ–≤–∞—é—Ç, –∞ –¥—Ä—É–≥–∏–µ –Ω–µ—Ç?",
                "body": f"–†–∞—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –º–µ—Ç–æ–¥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å {topic}. "
                        f"–ü—Ä–æ—Å—Ç–∞—è –ø–æ—à–∞–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤.",
                "cta": "üí¨ –ù–∞–ø–∏—à–∏—Ç–µ '–•–æ—á—É —É–∑–Ω–∞—Ç—å' –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö!",
                "hashtags": [f"#{topic}", "#—Ä–æ—Å—Ç", "#—Ä–∞–∑–≤–∏—Ç–∏–µ", "#–º–µ—Ç–æ–¥–∏–∫–∞"],
                "visual_tips": "–í–∏–¥–µ–æ-–æ—Ç–∑—ã–≤—ã –¥–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"
            }
        ]

        return random.choice(posts_pool)

    async def generate_content_plan(
        self,
        user_id: int,
        business_description: str,
        theme: str = "–æ–±—â–∞—è"
    ) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞ –Ω–∞ 30 –¥–Ω–µ–π (–∑–∞–≥–ª—É—à–∫–∞)"""

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 30 –¥–Ω–µ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        daily_posts = []
        for day in range(1, 31):
            themes = {
                "educational": ["–û–±—É—á–µ–Ω–∏–µ", "–°–æ–≤–µ—Ç—ã", "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"],
                "sales": ["–ê–∫—Ü–∏–∏", "–ö–µ–π—Å—ã", "–û—Ç–∑—ã–≤—ã"],
                "community": ["–û–ø—Ä–æ—Å—ã", "–ò—Å—Ç–æ—Ä–∏–∏", "–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è"],
                "brand": ["–¶–µ–Ω–Ω–æ—Å—Ç–∏", "–ú–∏—Å—Å–∏—è", "–ö–æ–º–∞–Ω–¥–∞"]
            }

            topic_types = themes.get(theme, ["–ù–æ–≤–æ—Å—Ç–∏", "–°–æ–≤–µ—Ç—ã", "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è"])
            topic_type = random.choice(topic_types)

            daily_posts.append({
                "day": day,
                "topic": f"{topic_type} –ø–æ {business_description.split()[0] if business_description else '–±–∏–∑–Ω–µ—Å—É'}",
                "format": random.choice(["–ü–æ—Å—Ç", "–°—Ç–æ—Ä–∏—Å", "–í–∏–¥–µ–æ", "–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä"]),
                "goal": random.choice(["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ", "–ü—Ä–æ–¥–∞–∂–∏", "–¢—Ä–∞—Ñ–∏–∫", "–£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å"]),
                "platform": random.choice(["Instagram", "Telegram", "VK"])
            })

        return {
            "strategy_overview": f"–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –¥–ª—è {business_description} —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ {theme} —Ç–µ–º–∞—Ç–∏–∫—É",
            "daily_posts": daily_posts,
            "key_metrics": "–û—Ö–≤–∞—Ç 100K, –∫–æ–Ω–≤–µ—Ä—Å–∏—è 3%, —Ä–æ—Å—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ 2000/–º–µ—Å",
            "tools_recommendations": "Canva –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∏, Trello –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, Google Analytics –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏"
        }

    async def generate_business_ideas(
        self,
        user_id: int,
        interests: str,
        budget: str = "–Ω–µ —É–∫–∞–∑–∞–Ω"
    ) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–∏–¥–µ–π (–∑–∞–≥–ª—É—à–∫–∞)"""

        ideas_pool = [
            {
                "title": "–û–Ω–ª–∞–π–Ω-–∫—É—Ä—Å—ã –ø–æ –≤–∞—à–µ–π —Ç–µ–º–µ",
                "description": f"–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ {interests}",
                "investment": "10-50K —Ä—É–±–ª–µ–π",
                "profit_potential": "50-200K —Ä—É–±–ª–µ–π/–º–µ—Å",
                "steps": [
                    "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –∫—É—Ä—Å–∞",
                    "–ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ—É—Ä–æ–∫–∏",
                    "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∫–ª–∞–º—É",
                    "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏"
                ],
                "risks": "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã"
            },
            {
                "title": "Telegram-–±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏",
                "description": f"–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–æ—Ç–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á –≤ {interests}",
                "investment": "5-20K —Ä—É–±–ª–µ–π",
                "profit_potential": "30-100K —Ä—É–±–ª–µ–π/–º–µ—Å",
                "steps": [
                    "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏",
                    "–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª",
                    "–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏",
                    "–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é"
                ],
                "risks": "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞"
            }
        ]

        return {
            "ideas": ideas_pool,
            "market_trends": "–†–∞—Å—Ç–µ—Ç —Å–ø—Ä–æ—Å –Ω–∞ –æ–Ω–ª–∞–π–Ω-–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é",
            "success_tips": "–ù–∞—á–Ω–∏—Ç–µ —Å MVP, —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—ã, —Å–æ–±–∏—Ä–∞–π—Ç–µ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å"
        }

    async def get_user_marketing_history(
        self,
        user_id: int,
        limit: int = 10
    ) -> List[Dict[str, Any]]:
        """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –∏–¥–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        async with self.db.get_uow() as uow:
            ideas = await uow.marketing_ideas.get_by_user_id(user_id, limit)
            return [
                {
                    "id": idea.id,
                    "title": idea.idea_title,
                    "niche": idea.niche,
                    "goal": idea.goal,
                    "platform": idea.platform,
                    "created_at": idea.created_at
                }
                for idea in ideas
            ]

    async def get_marketing_statistics(
        self,
        user_id: int
    ) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É"""
        async with self.db.get_uow() as uow:
            return await uow.marketing_ideas.get_user_statistics(user_id)