from aiogram import Router, F
from aiogram.types import Message
from aiogram.fsm.context import FSMContext

from app.service import user_service

router = Router()


@router.message(F.text.contains("–∞–Ω–∞–ª–∏–∑") | F.text.contains("–æ—Ç—á–µ—Ç") | F.text.contains("–ø—Ä–æ–¥–∞–∂"))
async def handle_analysis_request(message: Message, conversation_service):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö"""
    user_id = message.from_user.id

    await message.answer("üìä –°–æ–±–∏—Ä–∞—é –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...")

    # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π
    analysis_result = (
        "üìà **–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ –∑–∞ –Ω–µ–¥–µ–ª—é:**\n\n"
        "‚Ä¢ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: 150,000 —Ä—É–±.\n"
        "‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: 1,200 —Ä—É–±.\n"
        "‚Ä¢ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:\n"
        "  - –ö–∞–ø—É—á–∏–Ω–æ: 45,000 —Ä—É–±.\n"
        "  - –õ–∞—Ç—Ç–µ: 38,000 —Ä—É–±.\n"
        "  - –í—ã–ø–µ—á–∫–∞: 25,000 —Ä—É–±.\n\n"
        "üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–≤–µ–ª–∏—á–∏—Ç—å –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –≤—ã–ø–µ—á–∫–∏"
    )

    await message.answer(analysis_result)
    await conversation_service.save_conversation(user_id, message.text, analysis_result, "analytics")


@router.message(F.text.contains("–æ—Ç–≤–µ—Ç") | F.text.contains("–∫–ª–∏–µ–Ω") | F.text.contains("—à–∞–±–ª–æ–Ω"))
async def handle_template_request(message: Message, conversation_service):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ —à–∞–±–ª–æ–Ω–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤"""
    quick_responses = (
        "üí¨ **–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞–º:**\n\n"
        "üìû **–û—Ç—Å–ª–µ–¥–∏—Ç—å –∑–∞–∫–∞–∑:**\n"
        "–í–∞—à –∑–∞–∫–∞–∑ ‚Ññ12345 –≤ –ø—É—Ç–∏, –æ—Ç—Å–ª–µ–¥–∏—Ç—å –º–æ–∂–Ω–æ –ø–æ —Å—Å—ã–ª–∫–µ: track-link.ru/12345\n\n"

        "‚ö†Ô∏è **–û—Ç–≤–µ—Ç –Ω–∞ –∂–∞–ª–æ–±—É:**\n"
        "–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–æ! –ú—ã —É–∂–µ —Ä–∞–∑–±–∏—Ä–∞–µ–º—Å—è –≤ —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞.\n\n"

        "‚ùì **–£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π:**\n"
        "–£—Ç–æ—á–Ω–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –Ω–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–≤—è–∑–∏?\n\n"

        "‚ù§Ô∏è **–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∑–∞ –æ—Ç–∑—ã–≤:**\n"
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! –û—á–µ–Ω—å —Ä–∞–¥—ã, —á—Ç–æ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å! –ñ–¥–µ–º –≤–∞—Å —Å–Ω–æ–≤–∞!\n\n"

        "–ù—É–∂–µ–Ω –æ—Å–æ–±—ã–π –æ—Ç–≤–µ—Ç? –û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –ø–æ–¥—Ä–æ–±–Ω–µ–µ."
    )

    await message.answer(quick_responses)
    await conversation_service.save_conversation(
        message.from_user.id, message.text, quick_responses, "templates"
    )


@router.message(F.text.contains("–¥–æ–≥–æ–≤–æ—Ä") | F.text.contains("–¥–æ–∫—É–º–µ–Ω—Ç"))
async def handle_document_request(message: Message, conversation_service):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    document_types = (
        "üìù **–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**\n\n"
        "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å:\n"
        "‚Ä¢ üìÑ –î–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥\n"
        "‚Ä¢ üìë –ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç\n"
        "‚Ä¢ üìß –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ\n"
        "‚Ä¢ üìã –ó–∞—è–≤–ª–µ–Ω–∏–µ/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\n\n"
        "–ö–∞–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω—É–∂–µ–Ω? –û–ø–∏—à–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ:\n"
        "‚Ä¢ '–¥–æ–≥–æ–≤–æ—Ä —Å –∫–ª–∏–µ–Ω—Ç–æ–º'\n"
        "‚Ä¢ '–∞–∫—Ç –¥–ª—è –ø–æ–¥—Ä—è–¥—á–∏–∫–∞'\n"
        "‚Ä¢ '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ'"
    )

    await message.answer(document_types)
    await conversation_service.save_conversation(
        message.from_user.id, message.text, document_types, "documents"
    )


@router.message(F.text.contains("–º–∞—Ä–∫–µ—Ç–∏–Ω–≥") | F.text.contains("–ø–æ—Å—Ç") | F.text.contains("–∞–∫—Ü–∏"))
async def handle_marketing_request(message: Message, conversation_service):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
    marketing_ideas = (
        "üìà **–ò–¥–µ–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞:**\n\n"
        "üéØ **–ê–∫—Ü–∏–∏ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏:**\n"
        "‚Ä¢ '2 –ø–æ —Ü–µ–Ω–µ 1' –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã\n"
        "‚Ä¢ –°–∫–∏–¥–∫–∞ 20% –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É WEEKEND\n"
        "‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 2000—Ä\n\n"

        "üì± **–î–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π:**\n"
        "‚Ä¢ –ü–æ—Å—Ç —Å –æ—Ç–∑—ã–≤–æ–º –∫–ª–∏–µ–Ω—Ç–∞ + —Ñ–æ—Ç–æ\n"
        "‚Ä¢ Stories —Å –ø—Ä–æ—Ü–µ—Å—Å–æ–º —Ä–∞–±–æ—Ç—ã\n"
        "‚Ä¢ –†–æ–∑—ã–≥—Ä—ã—à –∑–∞ —Ä–µ–ø–æ—Å—Ç\n\n"

        "üí° **–ì–æ—Ç–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã –ø–æ—Å—Ç–æ–≤:**\n"
        "–ù–∞–ø–∏—à–∏—Ç–µ '–ø–æ—Å—Ç –ø—Ä–æ —Å–∫–∏–¥–∫–∏' –∏–ª–∏ '–ø–æ—Å—Ç –ø—Ä–æ –Ω–æ–≤–∏–Ω–∫—É'"
    )

    await message.answer(marketing_ideas)
    await conversation_service.save_conversation(
        message.from_user.id, message.text, marketing_ideas, "marketing"
    )


@router.message(F.text.contains("–Ω–∞–ª–æ–≥") | F.text.contains("—é—Ä–∏") | F.text.contains("–æ—Ç—á–µ—Ç–Ω–æ—Å—Ç"))
async def handle_legal_request(message: Message, conversation_service):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö/—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
    legal_advice = (
        "‚öñÔ∏è **–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:**\n\n"
        "üìã **–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã:**\n"
        "‚Ä¢ –°—Ä–æ–∫–∏ —Å–¥–∞—á–∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏: –¥–æ 25 —á–∏—Å–ª–∞\n"
        "‚Ä¢ –ù–∞–ª–æ–≥–∏ –ò–ü: 6% —Å –¥–æ—Ö–æ–¥–æ–≤ –∏–ª–∏ 15% –¥–æ—Ö–æ–¥—ã-—Ä–∞—Å—Ö–æ–¥—ã\n"
        "‚Ä¢ –î–æ–≥–æ–≤–æ—Ä —Å —Ñ–∏–∑–ª–∏—Ü–æ–º: –Ω—É–∂–µ–Ω –∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç\n"
        "‚Ä¢ –ü—Ä–µ—Ç–µ–Ω–∑–∏—è –∫–ª–∏–µ–Ω—Ç–∞: –æ—Ç–≤–µ—Ç–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –¥–Ω–µ–π\n\n"

        "üí° **–°–æ–≤–µ—Ç:** –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —á–µ–∫–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã!\n\n"
        "–ó–∞–¥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:\n"
        "‚Ä¢ '–∫–∞–∫–∏–µ –Ω–∞–ª–æ–≥–∏ –ø–ª–∞—Ç–∏—Ç—å –ò–ü'\n"
        "‚Ä¢ '–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'\n"
        "‚Ä¢ '—Å—Ä–æ–∫–∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏'"
    )

    await message.answer(legal_advice)
    await conversation_service.save_conversation(
        message.from_user.id, message.text, legal_advice, "legal"
    )


@router.message(F.text.contains("–º–æ–π –±–∏–∑–Ω–µ—Å"))
async def handle_business_update(message: Message, user_service):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ñ–∏–ª—è"""
    user_id = message.from_user.id
    text = message.text.lower()

    if "–∫–æ—Ñ–µ" in text or "–∫–∞—Ñ–µ" in text:
        industry = "coffee"
        response = "‚úÖ –ó–∞–ø–æ–º–Ω–∏–ª: –≤–∞—à –±–∏–∑–Ω–µ—Å - –∫–æ—Ñ–µ–π–Ω—è/–∫–∞—Ñ–µ"
    elif "—Å–∞–ª–æ–Ω" in text or "–∫—Ä–∞—Å–æ—Ç" in text:
        industry = "beauty"
        response = "‚úÖ –ó–∞–ø–æ–º–Ω–∏–ª: –≤–∞—à –±–∏–∑–Ω–µ—Å - —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã"
    elif "–º–∞–≥–∞–∑–∏–Ω" in text or "—Ä–æ–∑–Ω–∏—á" in text:
        industry = "retail"
        response = "‚úÖ –ó–∞–ø–æ–º–Ω–∏–ª: –≤–∞—à –±–∏–∑–Ω–µ—Å - —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è"
    elif "—É—Å–ª—É–≥" in text:
        industry = "services"
        response = "‚úÖ –ó–∞–ø–æ–º–Ω–∏–ª: –≤–∞—à –±–∏–∑–Ω–µ—Å - —Å—Ñ–µ—Ä–∞ —É—Å–ª—É–≥"
    else:
        response = "‚ùå –ù–µ –ø–æ–Ω—è–ª –æ—Ç—Ä–∞—Å–ª—å –±–∏–∑–Ω–µ—Å–∞. –£—Ç–æ—á–Ω–∏—Ç–µ: '–º–æ–π –±–∏–∑–Ω–µ—Å: –∫–æ—Ñ–µ–π–Ω—è'"
        industry = None

    if industry:
        await user_service.update_user_profile(user_id, industry=industry)

    await message.answer(response)


@router.message(F.text)
async def handle_any_text(message: Message, conversation_service):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ª—é–±—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = message.from_user.id
    user_text = message.text

    # –ü—Ä–æ—Å—Ç—ã–µ –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
    quick_replies = {
        "–ø—Ä–∏–≤–µ—Ç": "üëã –ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞—à–µ–º—É –±–∏–∑–Ω–µ—Å—É —Å–µ–≥–æ–¥–Ω—è?",
        "—Å–ø–∞—Å–∏–±–æ": "üôè –í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å!",
        "–∫–∞–∫ –¥–µ–ª–∞": "ü§ñ –û—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤ –ø–æ–º–æ–≥–∞—Ç—å –≤–∞—à–µ–º—É –±–∏–∑–Ω–µ—Å—É —Ä–∞—Å—Ç–∏!",
        "–ø–æ–º–æ—â—å": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç",
    }

    if user_text.lower() in quick_replies:
        response = quick_replies[user_text.lower()]
        await message.answer(response)
        await conversation_service.save_conversation(user_id, user_text, response, "general")
        return

    # –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –∑–∞–≥–ª—É—à–∫–∞ (–ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏–º –Ω–∞ AI)
    response = (
        "ü§î **–ü–æ–Ω–∏–º–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å!**\n\n"
        "–°–µ–π—á–∞—Å —è —Ä–∞–±–æ—Ç–∞—é –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. "
        "–í–∞—à –∑–∞–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∫–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á—É –ò–ò-–º–æ–¥—É–ª—å.\n\n"
        f"üìù **–í–∞—à –∑–∞–ø—Ä–æ—Å:** '{user_text}'\n"
        "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π\n\n"
        "–ê –ø–æ–∫–∞ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:\n"
        "‚Ä¢ '–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂' - –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç\n"
        "‚Ä¢ '–æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É' - —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π\n"
        "‚Ä¢ '–º–∞—Ä–∫–µ—Ç–∏–Ω–≥' - –∏–¥–µ–∏ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è"
    )

    await message.answer(response)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    category = "general"
    if any(word in user_text.lower() for word in ["–Ω–∞–ª–æ–≥", "—é—Ä–∏", "–æ—Ç—á–µ—Ç–Ω–æ—Å—Ç"]):
        category = "legal"
    elif any(word in user_text.lower() for word in ["–º–∞—Ä–∫–µ—Ç–∏–Ω–≥", "–ø–æ—Å—Ç", "–∞–∫—Ü–∏", "–ø—Ä–æ–¥–≤–∏–∂–µ–Ω"]):
        category = "marketing"
    elif any(word in user_text.lower() for word in ["–¥–æ–∫—É–º–µ–Ω—Ç", "–¥–æ–≥–æ–≤–æ—Ä", "–∞–∫—Ç"]):
        category = "documents"
    elif any(word in user_text.lower() for word in ["–∞–Ω–∞–ª–∏–∑", "–æ—Ç—á–µ—Ç", "–ø—Ä–æ–¥–∞–∂", "–¥–∞–Ω–Ω"]):
        category = "analytics"

    await conversation_service.save_conversation(user_id, user_text, response, category)